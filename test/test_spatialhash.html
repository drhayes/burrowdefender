<!DOCTYPE HTML>
<html>
	<head>
		<title>Spatial Hash</title>
		<script type="text/javascript" src="../lib/jquery/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="qunit.js"></script>
		<script type="text/javascript" src="../src/tile.js"></script>
		<script type="text/javascript" src="../src/spatialhash.js"></script>
		<link rel="stylesheet" href="qunit.css" type="text/css" media="screen" title="no title" charset="utf-8">
		<script>
			$(document).ready(function() {
				module('basics');
				
				test('ctor', function() {
					equals(typeof spatialhash, 'function', 'spatialhash exists');
					var sh = spatialhash();
					ok(sh.spacemap, 'The spacemap exists');
				});
				
				module('usage', {
					setup: function() {
						this.sh = spatialhash();
					}
				});
				
				test('get and set', function() {
					ok(this.sh.get, 'get method');
					ok(this.sh.set, 'set method');
					var r1 = {x1: 0, y1: 0, x2: 32, y2: 32};
					ok(this.sh.get(r1).length == 0, 'get from empty returns empty list');
					this.sh.set(r1);
					var x = this.sh.get(r1);
					ok(x.length === 1, 'get with one object returns it in list');
					equals(x[0], r1, 'it is the o object');
				});
				
				test('set and remove', function() {
					ok(this.sh.remove, 'remove method');
					var o1 = {x1: 0, y1: 0, x2: 10, y2: 10};
					var o2 = {x1: 15, y1: 15, x2: 25, y2: 25};
					this.sh.set(o1);
					this.sh.set(o2);
					var x = this.sh.get(o1);
					ok(x.length === 2, 'get with two objects returns them in a list');
					this.sh.remove(o1);
					x = this.sh.get(o1);
					ok(x.length === 1, 'remove pulled the o1 object');
					equals(x[0], o2, 'o2 is the object that is left');
				});
				
				test('get with velocity', function() {
					// this test will break if cellsize changes
					var o1 = {x1: 0, y1: 0, x2: 32, y2: 32};
					var o2 = {x1: 64, y1: 64, x2: 80, y2: 80};
					this.sh.set(o1);
					this.sh.set(o2);
					var o3 = {x1: 63, y1: 63, x2: 64, y2: 64};
					var x = this.sh.get(o3, 1, 1);
					equals(x.length, 2, 'get with velocity returned two objects');
					equals(x[0], o1, 'first object');
					equals(x[1], o2, 'second object');
				});
				
				test('get and set with big rect', function() {
					// this test will break if cellsize changes too much
					var r1 = {x1: 0, y1: 0, x2: 120, y2: 120};
					var r2 = {x1: 0, y1: 0, x2: 16, y2: 16};
					var r3 = {x1: 64, y1: 64, x2: 80, y2: 80};
					this.sh.set(r1);
					var x = this.sh.get(r2);
					equals(x.length, 1, 'get 0,0');
					equals(x[0], r1, 'it is the rect we set');
					x = this.sh.get(r3);
					equals(x.length, 1, 'get 64, 64');
					equals(x[0], r1, 'it is the rect we set');
				});
				
				test('set and remove with big rect', function() {
					// this test will break if cellsize changes too much
					var r1 = {x1: 0, y1: 0, x2: 120, y2: 120};
					var r2 = {x1: 0, y1: 0, x2: 16, y2: 16};
					var r3 = {x1: 64, y1: 64, x2: 80, y2: 80};
					this.sh.set(r1);
					// verify it is there in a couple of places
					var x = this.sh.get(r2);
					equals(x.length, 1, 'get 0,0');
					equals(x[0], r1, 'it is the rect we set');
					x = this.sh.get(r3);
					equals(x.length, 1, 'get 64, 64');
					equals(x[0], r1, 'it is the rect we set');
					// now remove an equivalent one
					var r1again = {x1: r1.x1, y1: r1.y1, x2: r1.x2, y2: r1.y2};
					this.sh.remove(r1again);
					equals(this.sh.get(r2).length, 0, 'removed from 0,0');
					equals(this.sh.get(r3).length, 0, 'removed from 64, 64');
				});
				
				test('get big rect', function() {
					// this test will break if cellsize changes too much
					var r1 = {x1: 0, y1: 0, x2: 16, y2: 16};
					var r2 = {x1: 64, y1: 64, x2: 80, y2: 80};
					var r3 = {x1: 32, y1: 32, x2: 120, y2: 120};
					this.sh.set(r1);
					this.sh.set(r2);
					// verify that both those come back because our query rect
					// is so frickin' huge
					var x = this.sh.get(r3);
					equals(x.length, 2, 'got two rects');
					equals(x[0], r1, 'r1');
					equals(x[1], r2, 'r2');
				});
				
				test('get and set preserve other properties', function() {
					var r1 = {
						x1: 0, y1: 0, x2: 10, y2: 10,
						solid: false,
						collide: function() {}
					};
					this.sh.set(r1);
					var list = this.sh.get({x1: 5, y1: 5, x2: 8, y2: 8});
					ok(list, 'list came back');
					equals(list.length, 1, 'list has a thing in it');
					var r2 = list[0];
					ok(r2.hasOwnProperty('solid'), 'solid exists on the returned object');
					ok(r2.hasOwnProperty('collide'), 'collide exists on the returned object');
				});
			});
		</script>
	</head>
	<body>
		<h1 id="qunit-header">Spatial Hash Test</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<div id="qunit-fixture">test markup, will be hidden</div>
	</body>
</html>