<!DOCTYPE HTML>
<html>
	<head>
		<title>Game</title>
		<script type="text/javascript" src="../lib/jquery/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="qunit.js"></script>
		<script type="text/javascript" src="../src/eventer.js"></script>
		<script type="text/javascript" src="../src/utils.js"></script>
		<script type="text/javascript" src="../src/tile.js"></script>
		<script type="text/javascript" src="../src/tilemap.js"></script>
		<script type="text/javascript" src="../src/mob.js"></script>
		<script type="text/javascript" src="../src/spatialhash.js"></script>
		<script type="text/javascript" src="../src/tilegenerator.js"></script>
		<script type="text/javascript" src="../src/keyboardmanager.js"></script>
		<script type="text/javascript" src="../src/updater.js"></script>
		<script type="text/javascript" src="../src/player.js"></script>
		<script type="text/javascript" src="../src/game.js"></script>
		<script type="text/javascript" src="fakes.js"></script>
		<link rel="stylesheet" href="qunit.css" type="text/css" media="screen" title="no title" charset="utf-8">
		<script>
			$(document).ready(function() {
				module('basics');
				
				test('game', function() {
					ok(typeof(Game) !== 'undefined', 'game defined');
					var g = new Game('#testcanvas');
					ok(g.canvas, 'g.canvas');
					ok(g.ctx, 'g.ctx');
					equals(g.width, 250, 'canvas width');
					equals(g.height, 150, 'canvas height');
					ok(g.tilemap, 'g.tilemap');
					ok(g.spatialhash, 'g.spatialhash');
					ok(g.tilegenerator, 'g.tilegenerator');
					ok(g.keyboardmanager, 'g.keyboardmanager');
					ok(g.playeroffset, 'g.playeroffset');
					equals(g.playeroffset.x, 125, 'g.playeroffset.x');
					equals(g.playeroffset.y, 75, 'g.playeroffset.y');
					ok(g.updater, 'g.updater');
					ok(g.player, 'g.player');
					equals(g.player.x, 0, 'g.player.x');
					equals(g.player.y, -200, 'g.player.y');
					equals(g.drawables.length, 2, 'background and player');
					equals(g.tickables.length, 1, 'player');
					equals(g.movables.length, 1, 'player');
				});
				
				module('usage', {
					setup: function() {
						this.g = new Game('#testcanvas');
						// get rid of the game's built-in tasks for these tests
						this.g.drawables = [];
						this.g.tickables = [];
						this.g.movables = [];
						this.g.others = [];
						this.fakectx = new FakeCtx();
					}
				});
				
				test('start', function() {
					ok(typeof(this.g.start) === 'function', 'g.start');
					this.g.start();
					ok(this.g.updater.timer, 'timer is running');
					this.g.updater.stop();
				});
				
				test('add', function() {
					ok(typeof(this.g.add) === 'function', 'g.add');
					var drawable = {
						draw: {}
					};
					var tickable = {
						tick: function() {}
					};
					var movable = {
						move: function() {}
					};
					var both = {
						tick: function() {},
						draw: {}
					};
					var other = function() {};
					equals(this.g.drawables.length, 0, 'g.drawables.length is 0');
					equals(this.g.tickables.length, 0, 'g.tickable.length is 0');
					equals(this.g.movables.length, 0, 'g.movable.length is 0');
					equals(this.g.others.length, 0, 'g.others.length is 0');
					this.g.add(drawable);
					equals(this.g.drawables.length, 1, 'drawables gets added');
					equals(this.g.tickables.length, 0, 'tickables is not added');
					equals(this.g.movables.length, 0, 'movables is not added');
					equals(this.g.others.length, 0, 'g.others.length is 0');
					this.g.add(tickable);
					equals(this.g.drawables.length, 1, 'drawables is not added');
					equals(this.g.tickables.length, 1, 'tickables gets added');
					equals(this.g.movables.length, 0, 'movables is not added');
					equals(this.g.others.length, 0, 'g.others.length is 0');
					this.g.add(movable);
					equals(this.g.drawables.length, 1, 'drawables is not added');
					equals(this.g.tickables.length, 1, 'tickables is not added');
					equals(this.g.movables.length, 1, 'movables gets added');
					equals(this.g.others.length, 0, 'g.others.length is 0');
					this.g.add(both);
					equals(this.g.drawables.length, 2, 'drawables is not added');
					equals(this.g.tickables.length, 2, 'tickables is not added');
					equals(this.g.movables.length, 1, 'movables is not added');
					equals(this.g.others.length, 0, 'g.others.length is 0');
					this.g.add(other);
					equals(this.g.drawables.length, 2, 'drawables is not added');
					equals(this.g.tickables.length, 2, 'tickables is not added');
					equals(this.g.movables.length, 1, 'movables is not added');
					equals(this.g.others.length, 1, 'g.others.length is 1');
				});
				
				test('update', function() {
					ok(typeof(this.g.update) === 'function', 'update exists');
					equals(this.g.updater.processes.length, 1, 'there is an update process');
					var thing = {
						tick: function() {
							this.ticked = true;
						},
						move: function() {
							this.moved = true;
						},
						vel: {
							x: 0,
							y: 0
						}
					};
					this.g.add(thing);
					this.g.update();
					ok(thing.ticked, 'ticked');
					ok(thing.moved, 'moved');
				});
				
				test('clearbackground', function() {
					ok(typeof(this.g.clearbackground) === 'function', 'clearbackground exists');
					this.g.clearbackground(this.fakectx);
					equals(this.fakectx.fillRectArgs.length, 1, 'fillRect called');
					var args = this.fakectx.fillRectArgs[0];
					equals(args.frx, 0, 'fillRect x');
					equals(args.fry, 0, 'fillRect y');
					equals(args.frw, this.g.width, 'fillRect w');
					equals(args.frh, this.g.height, 'fillRect h');
				});
				
				test('drawtiles', function() {
					ok(typeof(this.g.drawtiles) === 'function', 'drawtiles exists');
					this.g.tilemap = {
						draw: function(ctx, x, y) {
							this.ctx = ctx;
							this.x = x;
							this.y = y;
						}
					};
					this.g.player.x = -30;
					this.g.player.y = 200;
					this.g.drawtiles(this.fakectx);
					same(this.g.tilemap.ctx, this.fakectx, 'tilemap has right ctx');
					equals(this.g.tilemap.x, -155, 'tilemap.draw x');
					equals(this.g.tilemap.y, 125, 'tilemap.draw y');
				});
				
				module('layered drawing')
			});
		</script>
	</head>
	<body>
		<h1 id="qunit-header">Game Test</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<div id="qunit-fixture">test markup, will be hidden</div>
		<canvas id="testcanvas" width="250" height="150"></canvas>
	</body>
</html>