<!DOCTYPE HTML>
<html>
	<head>
		<title>TileMap</title>
		<script type="text/javascript" src="../lib/jquery/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="qunit.js"></script>
		<script type="text/javascript" src="../src/utils.js"></script>
		<script type="text/javascript" src="../src/mob.js"></script>
		<script type="text/javascript" src="../src/pickup.js"></script>
		<script type="text/javascript" src="../src/tile.js"></script>
		<script type="text/javascript" src="../src/tilemap.js"></script>
		<script type="text/javascript" src="fakes.js"></script>
		<link rel="stylesheet" href="qunit.css" media="screen" title="no title">
		<script type="text/javascript" charset="utf-8">
			$(document).ready(function() {
				module('basics');

				test('ctor', function() {
					equals(typeof(tilemap), 'function', 'tilemap exists');
					var tm = tilemap(600, 500);
					ok(tm, 'should get object back');
					ok(tm.tilemap, 'should have a tilemap');
					// prove that it starts out empty somehow
					var x = 0;
					for (prop in tm.tilemap) {
						x++;
					}
					ok(x === 0, 'the tilemap should be empty');
					ok(typeof(tm.draw) === 'function', 'draw exists');
				});

				test('makekey', function() {
					ok(typeof(tilemap.makekey) == 'function', 'makekey is a function');
					ok(tilemap.makekey(3, 4) === '3:4', '3,4 becomes the key "3:4"');
					ok(tilemap.makekey(-2, 4) === '-2:4', '-2,4 becomes the key "-2:4"');
				});
				
				test('parsekey', function() {
					ok(typeof(tilemap.parsekey) === 'function', 'parsekey is a function');
					var key = tilemap.parsekey('0:0');
					equals(key.x, 0, 'x for key 0:0');
					equals(key.y, 0, 'y for key 0:0');
					key = tilemap.parsekey('-3:-4');
					equals(key.x, -3, 'x for key -3:-4');
					equals(key.y, -4, 'y for key -3:-4');
				});
				
				module('usage', {
					'setup': function() {
						this.fakegame = new FakeGame();
						this.tm = tilemap();
					}
				});
				
				test('get and set', function() {
					ok(typeof(this.tm.get) == 'function', 'get is a function');
					ok(typeof(this.tm.set) == 'function', 'set is a function');
					var t = this.tm.get(0, 0);
					ok(!t.diggable, '0,0 has an non-diggable tile');
					var t2 = this.tm.get(3, -2);
					ok(!t2.diggable, 'gee, looks like it is all non-diggable');
					equals(t, t2, 'since they are the same, I bet they are air tiles');
					var dirt = tile.dirt({game: this.fakegame});
					this.tm.set(0, 0, dirt);
					var key = tilemap.makekey(0, 0);
					ok(this.tm.tilemap[key] === dirt, 'the dirt tile is in the tilemap');
					ok(this.tm.get(0, 0) === dirt, 'the dirt tile we set is gettable');
				});
				
				module('drawing', {
					setup: function() {
						// for the purposes of these tests, Air doesn't have a draw method
						this.oldair = tile.air;
						tile.air = function() {
							var that = {};
							that.draw = function() {};
							return that;
						}
						this.tm = new tilemap(64, 64);
						this.fakectx = new FakeCtx();
						this.fakegame = new FakeGame();
					},
					teardown: function() {
						tile.air = this.oldair;
					}
				})
				
				test('draw with two tiles noscroll', function() {
					this.tm = tilemap(tile.tilesize * 4, tile.tilesize * 4);
					this.tm.set(0, 3, tile.dirt({game: this.fakegame}));
					this.tm.set(1, 3, tile.dirt({game: this.fakegame}));
					this.tm.draw(this.fakectx);
					equals(this.fakectx.fillRectArgs.length, 25, 'called twice');
					var args = this.fakectx.fillRectArgs
					equals(args[0].frx, 0, 'first frx');
					equals(args[0].fry, 0, 'first fry');
					equals(args[0].frw, tile.tilesize, 'first frw');
					equals(args[0].frh, 33, 'first frh');
					equals(args[1].frx, 0, 'second frx');
					equals(args[1].fry, 0, 'second fry');
					equals(args[1].frw, tile.tilesize, 'second frw');
					equals(args[1].frh, 33, 'second frh');
					equals(args[1].offy, 32, 'offset.y');
				});
				
				test('draw with two tiles scroll tilesize aligned', function() {
					for (var i = 0; i < 5; i++) {
						this.tm.set(i, 0, new tile.dirt({game: this.fakegame}));
					}
					// first test the easy tilesize-aligned version
					this.tm.draw(this.fakectx, 32, 0);
					equals(this.fakectx.fillRectArgs.length, 9, 'called 9 times');
					var args = this.fakectx.fillRectArgs;
					equals(args[0].frx, 0, 'first frx');
					equals(args[0].fry, 30, 'first fry');
					equals(args[1].frx, 0, 'second frx');
					equals(args[1].fry, 0, 'second fry');
					equals(args[1].offy, 32, 'offset.y');
					equals(args[2].frx, 0, 'third frx');
					equals(args[2].fry, 0, 'third fry');
					equals(args[2].offy, 64, 'offset.y');
				});
				
				test('draw with three tiles not tilesize aligned', function() {
					for (var i = 0; i < 5; i++) {
						this.tm.set(i, 0, new tile.dirt({game: this.fakegame}));
					}
					// non tilesize aligned
					this.tm.draw(this.fakectx, 20, 0);
					equals(this.fakectx.fillRectArgs.length, 9, 'called 9 times');
					var args = this.fakectx.fillRectArgs;
					equals(args[0].frx, 0, 'first frx');
					equals(args[0].offx, -20, 'offset.y');
					equals(args[1].frx, 0, 'second frx');
					equals(args[1].offx, -20, 'offset.y');
					equals(args[2].frx, 0, 'third frx');
					equals(args[2].offx, -20, 'offset.y');
				});				
			});
		</script>
	</head>
	<body>
		<h1 id="qunit-header">TileMap Test</h1>
 		<h2 id="qunit-banner"></h2>
 		<h2 id="qunit-userAgent"></h2>
 		<ol id="qunit-tests"></ol>
 		<div id="qunit-fixture">test markup, will be hidden</div>
	</body>
</html>
