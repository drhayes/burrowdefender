<!DOCTYPE HTML>
<html>
	<head>
		<title>Mob</title>
		<script type="text/javascript" src="../lib/jquery/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="qunit.js"></script>
		<script type="text/javascript" src="../src/utils.js"></script>
		<script type="text/javascript" src="../src/mob.js"></script>
		<link rel="stylesheet" href="qunit.css" type="text/css" media="screen" title="no title" charset="utf-8">
		<script>
			$(document).ready(function() {
				module('basics');
				
				test('ctor', function() {
					ok(typeof(Mob) !== 'undefined', 'mob ctor exists');
					var mob = new Mob();
					equals(mob.x, 0, 'initial x pos');
					equals(mob.y, 0, 'initial y pos');
					equals(mob.size.x, 16, 'initial x size');
					equals(mob.size.y, 16, 'initial y size');
					equals(mob.vel.x, 0, 'initial x velocity');
					equals(mob.vel.y, 0, 'initial y velocity');
					ok(mob.movestate, 'movestate');
					ok(mob.velocities, 'velocities');
				});
				
				test('ctor with options', function() {
					var mob = new Mob({
						x: 30,
						vel: {
							x: -3,
							y: 5
						}
					});
					equals(mob.x, 30, 'mob.x === 30');
					equals(mob.vel.x, -3, 'mob.vel.x === -3');
					equals(mob.vel.y, 5, 'mob.vel.y === 5');
				});
				
				module('usage', {
					setup: function() {
						this.m = new Mob({
							x: 5,
							y: 5,
							size: {
								x: 30,
								y: 30
							},
							vel: {
								x: 0,
								y: 0
							}
						});
					}
				});
				
				test('updaterect', function() {
					ok(typeof(this.m.updaterect) !== 'undefined', 'updaterect defined');
					this.m.updaterect();
					equals(this.m.x1, this.m.x, 'x1 is m.x');
					equals(this.m.y1, this.m.y, 'y1 is m.y');
					equals(this.m.x2, this.m.x + this.m.size.x, 'x2 is m.x + m.size.x');
					equals(this.m.y2, this.m.y + this.m.size.y, 'y2 is m.y + m.size.y');
				});
				
				test('gravitytick', function() {
					ok(typeof(Mob.gravitytick) === 'function', 'gravity tick is a function');
					this.m.movestate.standing = true;
					for (var i = 0; i < 10; i++) {
						Mob.gravitytick.call(this.m);
					};
					equals(this.m.vel.y, 1, 'y velocity set to 1 when standing');
					this.m.movestate.standing = false;
					for (var i = 0; i < 10; i++) {
						Mob.gravitytick.call(this.m);
					};
					ok(this.m.vel.y > 0, 'gravity is taking effect');
					this.m.movestate.standing = true;
					Mob.gravitytick.call(this.m);
					ok(this.m.vel.y === 1, 'y velocity is 1 when standing');
				});

				test('move', function() {
					ok(typeof(this.m.move) !== 'undefined', 'move defined');
					this.m.vel.x = 5;
					this.m.vel.y = 3;
					this.m.move();
					equals(this.m.x, 10, 'x works');
					equals(this.m.y, 8, 'y works');
					equals(this.m.x1, this.m.x, 'm.x');
					equals(this.m.y1, this.m.y, 'm.y');
					equals(this.m.x2, this.m.x + this.m.size.x, 'm.x + m.size.x');
					equals(this.m.y2, this.m.y + this.m.size.y, 'm.y + m.size.y');
				});
				
				test('might as well be zero', function() {
					this.m.vel.x = 0.05;
					this.m.vel.y = 0.05;
					this.m.move();
					equals(this.m.x, 5, 'x velocity corrected to 0 from 0.05');
					equals(this.m.y, 5, 'y velocity corrected to 0 from 0.05');
					this.m.vel.x = -0.05;
					this.m.vel.y = -0.05;
					this.m.move();
					equals(this.m.x, 5, 'x velocity corrected to 0 from -0.05');
					equals(this.m.y, 5, 'y velocity corrected to 0 from -0.05');
				});
				
				test('move with collisions up with one', function() {
					// set the mob velocity up
					this.m.vel.y = -10;
					// collide in the y from the bottom
					var r1 = {x1: -25, y1: -30, x2: 50, y2: 0};
					this.m.move([r1]);
					equals(this.m.x, 5, 'did not collide in the x');
					equals(this.m.y, 1, 'collided in the y');
					equals(this.m.vel.y, -10, 'velocity did not change');
				});

				test('move with collisions down with one', function() {
					// set the mob velocity down
					this.m.vel.y = 10;
					// collide in the y from the top
					var r1 = {x1: -25, y1: 40, x2: 50, y2: 75};
					this.m.move([r1]);
					equals(this.m.x, 5, 'did not collide in the x');
					equals(this.m.y, 9, 'collided in the y');
					equals(this.m.vel.y, 10, 'velocity did not change');
				});
				
				test('move with collisions left with one', function() {
					// set the mob velocity left
					this.m.vel.x = -10;
					// collide in the x from the right
					var r1 = {x1: -35, y1: 0, x2: 0, y2: 30};
					this.m.move([r1]);
					equals(this.m.x, 1, 'collided in the x');
					equals(this.m.y, 5, 'did not collide in the y');
					equals(this.m.vel.x, -10, 'velocity did not change');
				});
				
				test('move with collisions right with one', function() {
					// set the mob velocity right
					this.m.vel.x = 10;
					// collide in the x from the left
					var r1 = {x1: 40, y1: 0, x2: 70, y2: 30};
					this.m.move([r1]);
					equals(this.m.x, 9, 'collided in the x');
					equals(this.m.y, 5, 'did not collide in the y');
					equals(this.m.vel.x, 10, 'velocity did not change');
				});
				
				test('move with collisions up with two', function() {
					// set the mob velocity up
					this.m.vel.y = -10;
					// collide in the y twice
					var r1 = {x1: -30, y1: -30, x2: 15, y2: 2};
					var r2 = {x1: 16, y1: -30, x2: 40, y2: 4};
					this.m.move([r1, r2]);
					equals(this.m.x, 5, 'did not collide in the x');
					equals(this.m.y, 5, 'collided in the y');
					equals(this.m.vel.y, -10, 'velocity did not change');
				});
				
				test('move with collisions up and to the left', function() {
					// set the mob velocity left and up
					this.m.vel.x = -10;
					this.m.vel.y = -10;
					// collide in the y from the bottom
					var r1 = {x1: -30, y1: -30, x2: 50, y2: 0};
					// collide in the x from the right
					var r2 = {x1: -40, y1: 0, x2: 0, y2: 50};
					this.m.move([r1, r2]);
					equals(this.m.x, 1, 'collided in the x');
					equals(this.m.y, 1, 'collided in the y');
					equals(this.m.vel.x, -10, 'velocity x did not change');
					equals(this.m.vel.y, -10, 'velocity y did not change');
				});
				
				test('move left and down on two adjacent objects', function() {
					var r1 = {x1: 0, y1: 96, x2: 31, y2: 127};
					var r2 = {x2: 32, y1: 96, x2: 63, y2: 127};
					// modify the mob we're testing to match the failing scenario
					this.m.x = 32;
					this.m.y = 75;
					this.m.vel.x = -1;
					this.m.vel.y = 1;
					this.m.size.x = 16;
					this.m.size.y = 20;
					this.m.move([r1, r2]);
					equals(this.m.x, 31, 'move 1 to the left');
					equals(this.m.y, 75, 'move 0 downwards');
				});
				
				test('move left and up on two adjacent objects', function() {
					var r1 = {x1: 0, y1: 96, x2: 31, y2: 127};
					var r2 = {x2: 32, y1: 96, x2: 63, y2: 127};
					// modify the mob we're testing to match the failing scenario
					this.m.x = 32;
					this.m.y = 128;
					this.m.vel.x = -1;
					this.m.vel.y = -1;
					this.m.size.x = 16;
					this.m.size.y = 20;
					this.m.move([r1, r2]);
					equals(this.m.x, 31, 'move 1 to the right');
					equals(this.m.y, 128, 'move 0 downwards');
				});
				
				module('jumping', {
					setup: function() {
						this.m = new Mob({
							x: 0,
							y: 0,
							size: {
								x: 10,
								y: 10
							},
							vel: {
								x: 0,
								y: 0
							}
						});
					}
				});
				
				test('basic jumping', function() {
					ok(this.m.movestate, 'movestate defined');
					equals(this.m.movestate.jumping, false, 'movestate.jumping');
					equals(this.m.movestate.standing, false, 'movestate.standing');
					this.m.jump();
					equals(this.m.movestate.jumping, false, 'jumping does not happen when not standing');
					this.m.movestate.standing = true;
					this.m.jump();
					equals(this.m.movestate.jumping, true, 'jumping happens when standing');
					equals(this.m.movestate.standing, false, 'no longer standing when jumping');
					equals(this.m.vel.y, this.m.velocities.jump, 'jumping velocity');
					this.m.vel.y = 0;
					this.m.jump();
					equals(this.m.vel.y, 0, 'y velocity does not change when already jumping');
				});
				
				test('standing', function() {
					equals(this.m.movestate.standing, false, 'standing starts false');
					this.m.vel.y = 1;
					var r1 = {x1: 0, y1: 11, x2: 10, y2: 21};
					this.m.move([r1]);
					equals(this.m.movestate.standing, true, 'standing is true when collide downward');
					this.m.move();
					equals(this.m.y, 1, 'fell downwards by 1');
					equals(this.m.movestate.standing, false, 'standing is false when falling');
					this.m.vel.y = 0;
					this.m.move();
					equals(this.m.movestate.standing, false, 'standing happens on collision, not on 0 y velocity');
				});
				
				test('jump twice', function() {
					this.m.movestate.standing = true;
					this.m.jump();
					equals(this.m.movestate.jumping, true, 'jumping while standing');
					this.m.vel.x = 0;
					this.m.vel.y = 0;
					this.m.jump();
					equals(this.m.vel.y, 0, 'y velocity still 0 because mob thinks it is still jumping');
					this.m.move();
					equals(this.m.movestate.jumping, true, 'y velocity 0 does not necessarily mean not jumping');
					var r = {x1: 0, y1: 11, x2: 20, y2: 21};
					this.m.vel.y = 1;
					this.m.move([r]);
					equals(this.m.movestate.jumping, false, 'jumping stops on downward collision');
				});
			});
		</script>
	</head>
	<body>
		<h1 id="qunit-header">Mob Test</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<div id="qunit-fixture">test markup, will be hidden</div>
	</body>
</html>